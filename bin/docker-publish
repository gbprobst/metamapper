#!/bin/bash
set -e

VERSION=$(python -c "from metamapper import __version__; print(__version__)")
VERSION_TAG="v$VERSION"

docker login -u $DOCKER_USER -p $DOCKER_PASS

if [ $CIRCLE_BRANCH = master ]
then
    docker build --build-arg env=production -t metamapper/preview:$CIRCLE_SHA1 .

    docker push metamapper/preview:$CIRCLE_SHA1
    echo "Pushed: metamapper/preview:$CIRCLE_SHA1"
else
    docker build --build-arg env=production -t metamapper/metamapper:$VERSION_TAG .

    docker push metamapper/metamapper:$VERSION_TAG
    echo "Pushed: metamapper/metamapper:$VERSION_TAG"
fi
